generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  RECEPTION
  TRIAGE
  DOCTOR
}

enum VisitStatus {
  REGISTERED
  WAITING_TRIAGE
  WAITING_DOCTOR
  IN_CONSULTATION
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum Priority {
  NORMAL
  URGENT
  CRITICAL
}

model User {
  
  id       String  @id @default(cuid())
  fullName String
  role     Role
  passwordHash String?
  pinHash  String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visitsAssigned Visit[]      @relation("AssignedDoctor")
  auditEvents    AuditEvent[]
}

model Service {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  rooms     Room[]
  visits    Visit[]
}

model Room {
  id        String   @id @default(cuid())
  name      String   @unique
  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  visits    Visit[]
}

model Patient {
  id         String    @id @default(cuid())
  fullName   String
  phone      String?
  email      String?
  nationalId String?
  dob        DateTime?
  gender     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visits Visit[]
}

model Visit {
  id          String      @id @default(cuid())
  visitNumber String      @unique
  status      VisitStatus
  priority    Priority    @default(NORMAL)
  completedAt DateTime?

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  assignedDoctorId String?
  assignedDoctor   User?   @relation("AssignedDoctor", fields: [assignedDoctorId], references: [id])

  roomId String?
  room   Room?   @relation(fields: [roomId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditEvents AuditEvent[]
}

model AuditEvent {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  visitId String?
  visit   Visit?  @relation(fields: [visitId], references: [id])

  action    String
  createdAt DateTime @default(now())
}
